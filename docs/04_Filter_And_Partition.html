---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_04_Filter_And_Partition.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When it comes to partitioning of the data, the following points should be considered:<br></p>
<ul>
<li>parallel processing has to be possible</li>
<li>most of the time, the all the data is processed as one group</li>
<li>it should also be possible to read data for a single company in an efficient way</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a simple approach, we will create new month and year columns for the "period" column and we will create a cik_mod_10 column, which is the cik module 10.<br>
This gives us the possibility to create the partition as year-month-cik_mod_10. Since we have about 10 years of data, this will create about 10<em>12</em>10=1200 partitions. So, every partition should have about 110'000'000 / 1'200, which is approx 100'000 entries.<br>
This way, we should be able to select efficiently by the period date and by the cik number (provided that we provide the appropriate selects criterias.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-partitions-with-the-test-dataframe">Create partitions with the test dataframe<a class="anchor-link" href="#Create-partitions-with-the-test-dataframe"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span>

<span class="n">df_tst_partition</span> <span class="o">=</span> <span class="n">df_tst_join</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;period_year&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">))</span> \
                         <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;period_month&quot;</span><span class="p">,</span> <span class="n">month</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">))</span> \
                         <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;cik_mod_10&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;cik&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tst_parquet_folder</span><span class="p">,</span>  <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_tst_partition</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;period_year&#39;</span><span class="p">,</span> <span class="s1">&#39;period_month&#39;</span><span class="p">,</span> <span class="s1">&#39;cik_mod_10&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">tst_parquet_folder</span><span class="p">)</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>duration:  338.159051656723
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">df_tst_partition</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">df_tst_partition</span><span class="o">.</span><span class="n">period_year</span> <span class="o">==</span> <span class="mi">2011</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+-------+--------------------+--------------------+------------+-----+----------+----+------+-----+--------+------------------+----+---------+------+---------------+-----+--------------------+----+------------+---------+------+---------------+-----+--------------------+----+----------+-------+---+--------------------+--------+-----+----+----+----+----------+----+---+----------+--------------------+-------+------+-----------------+-----+-----+------+----+----+-----+-----+--------------------+--------+------+--------------------+--------+-----------+------------+----------+
|    cik|                adsh|                 tag|     version|coreg|     ddate|qtrs|   uom|value|footnote|              name| sic|countryba|stprba|         cityba|zipba|                bas1|bas2|        baph|countryma|stprma|         cityma|zipma|                mas1|mas2|countryinc|stprinc|ein|              former| changed|  afs|wksi| fye|form|    period|  fy| fp|     filed|            accepted|prevrpt|detail|         instance|nciks|aciks|report|line|stmt|inpth|rfile|              plabel|negating|ticker|        name_cik_tic|exchange|period_year|period_month|cik_mod_10|
+-------+--------------------+--------------------+------------+-----+----------+----+------+-----+--------+------------------+----+---------+------+---------------+-----+--------------------+----+------------+---------+------+---------------+-----+--------------------+----+----------+-------+---+--------------------+--------+-----+----+----+----+----------+----+---+----------+--------------------+-------+------+-----------------+-----+-----+------+----+----+-----+-----+--------------------+--------+------+--------------------+--------+-----------+------------+----------+
|1415306|0001753926-19-000212|ClassOfWarrantOrR...|us-gaap/2019| null|2011-09-30|   0|shares|7.2E7|    null|PURESPECTRUM, INC.|7361|       US|    FL|WEST PALM BEACH|33401|224 DATURA STREET...|null|954-837-6800|       US|    FL|WEST PALM BEACH|33401|224 DATURA STREET...|null|        US|     DE|  0|INTERNATIONAL MED...|20071016|4-NON|   0|1231|10-Q|2011-09-30|2011| Q3|2019-10-21|2019-11-13 13:50:...|      0|     1|psru-20110930.xml|    1| null|  null|null|null| null| null|                null|    null|  PSRU|International Med...|     OTC|       2011|           9|         1|
|1415306|0001753926-19-000212|GainLossOnDisposi...|us-gaap/2019| null|2010-09-30|   3|   USD| null|    null|PURESPECTRUM, INC.|7361|       US|    FL|WEST PALM BEACH|33401|224 DATURA STREET...|null|954-837-6800|       US|    FL|WEST PALM BEACH|33401|224 DATURA STREET...|null|        US|     DE|  0|INTERNATIONAL MED...|20071016|4-NON|   0|1231|10-Q|2011-09-30|2011| Q3|2019-10-21|2019-11-13 13:50:...|      0|     1|psru-20110930.xml|    1| null|     4|  13|  IS|    0|    H|Loss on Asset Dis...|       0|  PSRU|International Med...|     OTC|       2011|           9|         1|
+-------+--------------------+--------------------+------------+-----+----------+----+------+-----+--------+------------------+----+---------+------+---------------+-----+--------------------+----+------------+---------+------+---------------+-----+--------------------+----+----------+-------+---+--------------------+--------+-----+----+----+----+----------+----+---+----------+--------------------+-------+------+-----------------+-----+-----+------+----+----+-----+-----+--------------------+--------+------+--------------------+--------+-----------+------------+----------+
only showing top 2 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

