---

title: 01_03_Merge_To_Single_Parquet

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_03_Merge_To_Single_Parquet.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The main goal of this notebook is to merge all quarterly-CSV files together into one Dataframe and store it as Parquet. Moreover, a schema with the correkt datatypes is defined, so that Parquet stores the types appropriately.<br>
In addition, the tickersymbol is also merged into the dataset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># imports</span>
<span class="kn">from</span> <span class="nn">bfh_cas_bgd_fs2020_sa.core</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1"># initialze spark</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.dataframe</span> <span class="kn">import</span> <span class="n">DataFrame</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">shutil</span>          <span class="c1"># provides high level file operations</span>
<span class="kn">import</span> <span class="nn">time</span>            <span class="c1"># used to measure execution time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># basic definitions</span>

<span class="c1"># our test folder just contains the content of two zip files</span>
<span class="n">tst_csv_folders</span> <span class="o">=</span> <span class="s2">&quot;./tmp/joined/&quot;</span>
<span class="n">tst_csv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tst_csv_folders</span><span class="p">)</span>
<span class="n">tst_csv_path_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tst_csv_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-paths: &quot;</span> <span class="p">,</span> <span class="n">tst_csv_path_list</span><span class="p">)</span>

<span class="n">tst_parquet_folder</span> <span class="o">=</span> <span class="s2">&quot;./tmp/parquet/&quot;</span>

<span class="c1"># The &quot;all&quot;-folder contains the csv files from all of the zipfiles </span>
<span class="n">all_csv_folders</span> <span class="o">=</span> <span class="s2">&quot;D:/data/zip_joined/&quot;</span>
<span class="n">all_csv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">all_csv_folders</span><span class="p">)</span>
<span class="n">all_csv_path_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_csv_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All-paths: &quot;</span><span class="p">,</span> <span class="n">all_csv_path_list</span><span class="p">)</span>

<span class="n">all_parquet_folder</span> <span class="o">=</span> <span class="s2">&quot;D:/data/parquet/&quot;</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Test-paths:  [&#39;2019q3&#39;, &#39;2019q4&#39;]
All-paths:  [&#39;2009q1&#39;, &#39;2009q2&#39;, &#39;2009q3&#39;, &#39;2009q4&#39;, &#39;2010q1&#39;, &#39;2010q2&#39;, &#39;2010q3&#39;, &#39;2010q4&#39;, &#39;2011q1&#39;, &#39;2011q2&#39;, &#39;2011q3&#39;, &#39;2011q4&#39;, &#39;2012q1&#39;, &#39;2012q2&#39;, &#39;2012q3&#39;, &#39;2012q4&#39;, &#39;2013q1&#39;, &#39;2013q2&#39;, &#39;2013q3&#39;, &#39;2013q4&#39;, &#39;2014q1&#39;, &#39;2014q2&#39;, &#39;2014q3&#39;, &#39;2014q4&#39;, &#39;2015q1&#39;, &#39;2015q2&#39;, &#39;2015q3&#39;, &#39;2015q4&#39;, &#39;2016q1&#39;, &#39;2016q2&#39;, &#39;2016q3&#39;, &#39;2016q4&#39;, &#39;2017q1&#39;, &#39;2017q2&#39;, &#39;2017q3&#39;, &#39;2017q4&#39;, &#39;2018q1&#39;, &#39;2018q2&#39;, &#39;2018q3&#39;, &#39;2018q4&#39;, &#39;2019q1&#39;, &#39;2019q2&#39;, &#39;2019q3&#39;, &#39;2019q4&#39;, &#39;2020q1&#39;, &#39;2020q2&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Init-Spark">Init Spark<a class="anchor-link" href="#Init-Spark"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark_session</span><span class="p">()</span> <span class="c1"># Session anlegen</span>
<span class="n">spark</span> <span class="c1"># display the moste important information of the session</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

            <div>
                <p><b>SparkSession - in-memory</b></p>
                
        <div>
            <p><b>SparkContext</b></p>

            <p><a href="http://192.168.0.163:4040">Spark UI</a></p>

            <dl>
              <dt>Version</dt>
                <dd><code>v2.4.5</code></dd>
              <dt>Master</dt>
                <dd><code>local[*]</code></dd>
              <dt>AppName</dt>
                <dd><code>default</code></dd>
            </dl>
        </div>
        
            </div>
        
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-Schmea-for-reading-from-CSV">Define Schmea for reading from CSV<a class="anchor-link" href="#Define-Schmea-for-reading-from-CSV"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span><span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">DateType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">BooleanType</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>  <span class="c1"># num.txt  \</span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> 	 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;coreg&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ddate&quot;</span><span class="p">,</span> 	 <span class="n">DateType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> <span class="c1"># date \ </span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;qtrs&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;uom&quot;</span><span class="p">,</span> 	 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> 	 <span class="n">DoubleType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;footnote&quot;</span><span class="p">,</span>  <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                      <span class="c1"># sub.txt \ </span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span> 	 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;sic&quot;</span><span class="p">,</span> 	 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;countryba&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;stprba&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;cityba&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;zipba&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;bas1&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;bas2&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;baph&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;countryma&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;stprma&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;cityma&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;zipma&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;mas1&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;mas2&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;countryinc&quot;</span><span class="p">,</span><span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;stprinc&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ein&quot;</span><span class="p">,</span> 	 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;former&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;changed&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;afs&quot;</span><span class="p">,</span> 	 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;wksi&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;fye&quot;</span><span class="p">,</span> 	     <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">,</span> 	 <span class="n">DateType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>  <span class="c1"># date \</span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;fy&quot;</span><span class="p">,</span> 	 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;fp&quot;</span><span class="p">,</span> 	 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;filed&quot;</span><span class="p">,</span> 	 <span class="n">DateType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> <span class="c1"># date \</span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;accepted&quot;</span><span class="p">,</span>  <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> <span class="c1"># datetime \</span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;prevrpt&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;instance&quot;</span><span class="p">,</span>  <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;nciks&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;aciks&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                      <span class="c1"># pre.txt \</span>
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;report&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;stmt&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;inpth&quot;</span><span class="p">,</span> 	 <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;rfile&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;plabel&quot;</span><span class="p">,</span> 	 <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span> \
                <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;negating&quot;</span><span class="p">,</span>  <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span> \
<span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Read-all-csv-files-into-one-DF">Read all csv files into one DF<a class="anchor-link" href="#Read-all-csv-files-into-one-DF"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Read-the-test-dataset">Read the test dataset<a class="anchor-link" href="#Read-the-test-dataset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_tst</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">tst_csv_folders</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dateFormat</span><span class="o">=</span><span class="s2">&quot;yyyyMMdd&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;{:_}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_tst</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span> <span class="c1"># print number of lines in the test dataset</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5_239_639
duration:  7.223994970321655
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Reading and counting just the two CSV-folders is really fast, but we have to be aware that they are stored on a SSD.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># df_tst.show(1) # if we need to check that reading the schema was possible</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Read-the-whole-dataset">Read the whole dataset<a class="anchor-link" href="#Read-the-whole-dataset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">all_csv_folders</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dateFormat</span><span class="o">=</span><span class="s2">&quot;yyyyMMdd&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;{:_}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span> <span class="c1"># print number of lines in the whole dataset</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>109_392_813
duration:  332.6548318862915
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first time, reading and counting all CSV-folders, takes about 7 minutes. But they are also read from "normal disk" and not a SSD. This is also clearly visible when checking the Windows Task Manager: The disk was at 100%. <br>
It took only 45 seconds the second time and when I checked the Windows Task Manager, the CPU was at 100% and the disk was at 0%. So it looks as if the system cached the whole data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#df_all.show(1) # if we need to check that reading the schema was possible</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Print-all-the-contained-column-names">Print all the contained column names<a class="anchor-link" href="#Print-all-the-contained-column-names"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_all</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="c1"># print the name of the columns for convenience</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>adsh, tag, version, coreg, ddate, qtrs, uom, value, footnote, cik, name, sic, countryba, stprba, cityba, zipba, bas1, bas2, baph, countryma, stprma, cityma, zipma, mas1, mas2, countryinc, stprinc, ein, former, changed, afs, wksi, fye, form, period, fy, fp, filed, accepted, prevrpt, detail, instance, nciks, aciks, report, line, stmt, inpth, rfile, plabel, negating, </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Merge-TickerSymbol-to-the-dataset">Merge TickerSymbol to the dataset<a class="anchor-link" href="#Merge-TickerSymbol-to-the-dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>During the further analysis, it could make sense to know the TickerSymbol and the Exchange where the stock is traded. This information is available in a CSV located at <a href="http://rankandfiled.com/static/export/cik_ticker.csv">http://rankandfiled.com/static/export/cik_ticker.csv</a>. We simply load it into a dataframe and use the join method to join it with the rest.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Read-the-cik-ticker-dataset">Read the cik-ticker dataset<a class="anchor-link" href="#Read-the-cik-ticker-dataset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="n">df_cik_ticker</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="s2">&quot;./data/cik_ticker.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)[[</span><span class="s1">&#39;CIK&#39;</span><span class="p">,</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Exchange&#39;</span><span class="p">]]</span>
<span class="c1"># renaming the column</span>
<span class="n">df_cik_ticker</span> <span class="o">=</span> <span class="n">df_cik_ticker</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s2">&quot;name_cik_tic&quot;</span><span class="p">)</span> \
                                <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span> \
                                <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;Exchange&#39;</span><span class="p">,</span> <span class="s2">&quot;exchange&quot;</span><span class="p">)</span> \
                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;CIK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cik_ticker</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+-------+------+--------------------+--------+
|    cik|ticker|        name_cik_tic|exchange|
+-------+------+--------------------+--------+
|1090872|     A|Agilent Technolog...|    NYSE|
|   4281|    AA|           Alcoa Inc|    NYSE|
|1332552| AAACU|Asia Automotive A...|    null|
|1287145|  AABB|  Asia Broadband Inc|     OTC|
|1024015|  AABC|Access Anytime Ba...|    null|
+-------+------+--------------------+--------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Available-exchanges-and-count-of-traded-stocks">Available exchanges and count of traded stocks<a class="anchor-link" href="#Available-exchanges-and-count-of-traded-stocks"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exchanges_df</span> <span class="o">=</span> <span class="n">df_cik_ticker</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;exchange&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span> <span class="c1"># we convert to pandas in order to visualize the data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">exchanges_df</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="c1"># </span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>col_0      count
exchange        
BATS           4
NASDAQ      2669
NYSE        2880
NYSE ARCA    115
NYSE MKT     561
OTC         2345
OTCBB        330
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Join-the-test-dataframe-with-the-cik_ticker-dataframe">Join the test dataframe with the cik_ticker dataframe<a class="anchor-link" href="#Join-the-test-dataframe-with-the-cik_ticker-dataframe"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's now join the test dataset together with the ticker information. We expect the same number of lines in the dataset as we had above.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_tst_join</span> <span class="o">=</span> <span class="n">df_tst</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_cik_ticker</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cik&quot;</span><span class="p">],</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;{:_}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_tst_join</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span> <span class="c1"># merge and display the number of lines in the test dataset</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5_239_639
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_tst_join</span><span class="p">[[</span><span class="s1">&#39;adsh&#39;</span><span class="p">,</span><span class="s1">&#39;cik&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;name_cik_tic&#39;</span><span class="p">,</span><span class="s1">&#39;exchange&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># show a few columns to make sure the join worked</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+--------------------+----+------+--------------------+--------+
|                adsh| cik|ticker|        name_cik_tic|exchange|
+--------------------+----+------+--------------------+--------+
|0000002178-19-000107|2178|    AE|Adams Resources &amp;...|NYSE MKT|
|0000002178-19-000107|2178|    AE|Adams Resources &amp;...|NYSE MKT|
+--------------------+----+------+--------------------+--------+
only showing top 2 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Join-the-complete-dataframe-with-the-cik_ticker-dataframe">Join the complete dataframe with the cik_ticker dataframe<a class="anchor-link" href="#Join-the-complete-dataframe-with-the-cik_ticker-dataframe"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We only create the definition of the joined dataframe, we don't execute it yet.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># join the all dataset with the ticker information</span>
<span class="n">df_all_join</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_cik_ticker</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cik&quot;</span><span class="p">],</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Storing-as-Parquet-with-default-partitions">Storing as Parquet with default partitions<a class="anchor-link" href="#Storing-as-Parquet-with-default-partitions"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The correct datytype is defined for each column and the tickersymbols have been added to the dataset. Now it is time to store the whole dataset as a new Parquet file.<br>
We will simply use Parquet's default partition.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-Parquet-file-with-default-partitions-on-the-test-dataset">Create Parquet file with default partitions on the test dataset<a class="anchor-link" href="#Create-Parquet-file-with-default-partitions-on-the-test-dataset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tst_parquet_folder</span><span class="p">,</span>  <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># make sure the target folder is empty</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_tst_join</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">tst_parquet_folder</span><span class="p">)</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>duration:  39.32404708862305
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-Parquet-file-with-default-partitions-on-the-whole-dataset">Create Parquet file with default partitions on the whole dataset<a class="anchor-link" href="#Create-Parquet-file-with-default-partitions-on-the-whole-dataset"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">all_parquet_folder</span><span class="p">,</span>  <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># make sure the target folder is empty</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_all_join</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">all_parquet_folder</span><span class="p">)</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>duration:  758.595376253128
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It took about 13 minutes to store all the data in parquet.<br>
Let us compare the file sizes of the compressed zip folder and the parquet folder:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;compressed zip: &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">get_directory_size</span><span class="p">(</span><span class="n">all_csv_folders</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parquet       : &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">get_directory_size</span><span class="p">(</span><span class="n">all_parquet_folder</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>compressed zip:  4.81GB
parquet       :  5.05GB
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is about the same size, especially if we consider that the Parquet version also contains the ticker information. Moreover, Parquet contains more metainformation which will help to faster access the data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Stop-Spark">Stop Spark<a class="anchor-link" href="#Stop-Spark"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

