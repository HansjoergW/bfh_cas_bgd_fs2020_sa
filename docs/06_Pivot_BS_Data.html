---

title: 01_06_Pivot_BS_Data

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_06_Pivot_BS_Data.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this notebook, we will transform the verticalized data rows of the BalanceSheet into a horizontalized dataframe.
<br>
Currently, our data looks similar to the table below. Every Value is placed on its own row.</p>
<table>
<thead><tr>
<th>bs_id</th>
<th>company</th>
<th>date</th>
<th>attribute</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>VitaSport</td>
<td>31.10.2018</td>
<td>Assets</td>
<td>100</td>
</tr>
<tr>
<td>1</td>
<td>VitaSport</td>
<td>31.10.2018</td>
<td>Cash</td>
<td>80</td>
</tr>
<tr>
<td>1</td>
<td>VitaSport</td>
<td>31.10.2018</td>
<td>Other</td>
<td>20</td>
</tr>
<tr>
<td>2</td>
<td>VitaSport</td>
<td>31.10.2019</td>
<td>Assets</td>
<td>120</td>
</tr>
<tr>
<td>2</td>
<td>VitaSport</td>
<td>31.10.2019</td>
<td>Cash</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>VitaSport</td>
<td>31.10.2019</td>
<td>Other</td>
<td>40</td>
</tr>
<tr>
<td>3</td>
<td>GloryFood</td>
<td>31.10.2019</td>
<td>Assets</td>
<td>50</td>
</tr>
<tr>
<td>3</td>
<td>GloryFood</td>
<td>31.10.2019</td>
<td>Cash</td>
<td>5</td>
</tr>
<tr>
<td>3</td>
<td>GloryFood</td>
<td>31.10.2019</td>
<td>Other</td>
<td>45</td>
</tr>
</tbody>
</table>
<p><br>
But what we would like to have one entry per BalanceSheet:</p>
<table>
<thead><tr>
<th>bs_id</th>
<th>company</th>
<th>date</th>
<th>Assets</th>
<th>Cash</th>
<th>Other</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>VitaSport</td>
<td>31.10.2018</td>
<td>100</td>
<td>80</td>
<td>20</td>
</tr>
<tr>
<td>2</td>
<td>VitaSport</td>
<td>31.10.2019</td>
<td>120</td>
<td>80</td>
<td>40</td>
</tr>
<tr>
<td>3</td>
<td>GloryFood</td>
<td>31.10.2019</td>
<td>50</td>
<td>5</td>
<td>45</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># imports</span>
<span class="kn">from</span> <span class="nn">bfh_cas_bgd_fs2020_sa.core</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1"># initialze spark</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.dataframe</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">pandas_udf</span><span class="p">,</span> <span class="n">PandasUDFType</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">shutil</span>          <span class="c1"># provides high level file operations</span>
<span class="kn">import</span> <span class="nn">time</span>            <span class="c1"># used to measure execution time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># folder with our test-dataset which contains only data from two zip files</span>
<span class="n">tst_filtered_folder</span> <span class="o">=</span> <span class="s2">&quot;./tmp/filtered/&quot;</span>
<span class="n">tst_bs_folder</span> <span class="o">=</span> <span class="s2">&quot;./tmp/bs/&quot;</span>

<span class="c1"># folder with the whole dataset as a single parquet</span>
<span class="n">all_filtered_folder</span> <span class="o">=</span> <span class="s2">&quot;D:/data/parq_filtered&quot;</span>
<span class="n">all_bs_folder</span> <span class="o">=</span> <span class="s2">&quot;D:/data/parq_bs&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Init-Spark">Init Spark<a class="anchor-link" href="#Init-Spark"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark_session</span><span class="p">()</span> <span class="c1"># Session anlegen</span>
<span class="n">spark</span> <span class="c1"># display the most important information of the session</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

            <div>
                <p><b>SparkSession - in-memory</b></p>
                
        <div>
            <p><b>SparkContext</b></p>

            <p><a href="http://192.168.0.163:4040">Spark UI</a></p>

            <dl>
              <dt>Version</dt>
                <dd><code>v2.4.5</code></dd>
              <dt>Master</dt>
                <dd><code>local[*]</code></dd>
              <dt>AppName</dt>
                <dd><code>default</code></dd>
            </dl>
        </div>
        
            </div>
        
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Load-the-dataset">Load the dataset<a class="anchor-link" href="#Load-the-dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading the data doesn't really do anything. It just prepares the df. But we well use the cache() method to keep the data in memory, once it is loaded for the first time.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-the-test-data">Load the test data<a class="anchor-link" href="#Load-the-test-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_tst</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">tst_filtered_folder</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-the-whole-dataset">Load the whole dataset<a class="anchor-link" href="#Load-the-whole-dataset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">all_filtered_folder</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Print-all-the-contained-column-names">Print all the contained column names<a class="anchor-link" href="#Print-all-the-contained-column-names"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_all</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="c1"># print the name of the columns for convenience</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>cik, adsh, tag, version, coreg, ddate, qtrs, uom, value, footnote, name, sic, countryba, stprba, cityba, zipba, bas1, bas2, baph, countryma, stprma, cityma, zipma, mas1, mas2, countryinc, stprinc, ein, former, changed, afs, wksi, fye, form, period, fy, fp, filed, accepted, prevrpt, detail, instance, nciks, aciks, report, line, stmt, inpth, rfile, plabel, negating, ticker, name_cik_tic, exchange, cik_select, </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading-data-into-memory">Loading data into memory<a class="anchor-link" href="#Loading-data-into-memory"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We just make a count on the test and the all dataset. This ensure that the data will be loaded into the memory and is cached afterwards.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entries in Test: &quot;</span><span class="p">,</span> <span class="s2">&quot;{:_}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_tst</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span> <span class="c1"># loading test dataset into memory</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Entries in Test:  1_680_108
duration:  13.733977556228638
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entries in Test: &quot;</span><span class="p">,</span> <span class="s2">&quot;{:_}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span> <span class="c1"># loading all dataset into memory</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;duration: &quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Entries in Test:  35_454_045
duration:  203.78116416931152
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since we filtered out about two thirds of the entries, loading the reduced data set takes only about 3 minutes to load it completely into memory</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Basics">Basics<a class="anchor-link" href="#Basics"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to test how to pivot the data, we implement a simple example to test the principle. Actually, der is a pivot function, which provides the desired functionality.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_bs_data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span> \
<span class="p">[</span> \
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;VitaSport&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2018&quot;</span><span class="p">,</span><span class="s2">&quot;Assets&quot;</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> \
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;VitaSport&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2018&quot;</span><span class="p">,</span><span class="s2">&quot;Cash  &quot;</span><span class="p">,</span><span class="mi">80</span> <span class="p">),</span> \
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;VitaSport&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2018&quot;</span><span class="p">,</span><span class="s2">&quot;Other &quot;</span><span class="p">,</span><span class="mi">20</span> <span class="p">),</span> \
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;VitaSport&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2019&quot;</span><span class="p">,</span><span class="s2">&quot;Assets&quot;</span><span class="p">,</span><span class="mi">120</span><span class="p">),</span> \
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;VitaSport&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2019&quot;</span><span class="p">,</span><span class="s2">&quot;Cash  &quot;</span><span class="p">,</span><span class="mi">80</span> <span class="p">),</span> \
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;VitaSport&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2019&quot;</span><span class="p">,</span><span class="s2">&quot;Other &quot;</span><span class="p">,</span><span class="mi">40</span> <span class="p">),</span> \
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;GloryFood&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2019&quot;</span><span class="p">,</span><span class="s2">&quot;Assets&quot;</span><span class="p">,</span><span class="mi">50</span> <span class="p">),</span> \
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;GloryFood&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2019&quot;</span><span class="p">,</span><span class="s2">&quot;Cash  &quot;</span><span class="p">,</span><span class="mi">5</span>  <span class="p">),</span> \
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;GloryFood&quot;</span><span class="p">,</span><span class="s2">&quot;31.10.2019&quot;</span><span class="p">,</span><span class="s2">&quot;Other &quot;</span><span class="p">,</span><span class="mi">45</span> <span class="p">)</span>  \
<span class="p">],</span> \
  <span class="p">(</span><span class="s2">&quot;bs_id&quot;</span><span class="p">,</span> <span class="s2">&quot;company&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> \
<span class="p">)</span>

<span class="n">df_bs_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;company&quot;</span><span class="p">,</span><span class="s2">&quot;bs_id&quot;</span><span class="p">,</span><span class="s2">&quot;date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+---------+-----+----------+------+------+------+
|  company|bs_id|      date|Assets|Cash  |Other |
+---------+-----+----------+------+------+------+
|VitaSport|    2|31.10.2019|   120|    80|    40|
|VitaSport|    1|31.10.2018|   100|    80|    20|
|GloryFood|    3|31.10.2019|    50|     5|    45|
+---------+-----+----------+------+------+------+

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This looks simple. But it could be, that we will get more than one result. In the above sample, we just used the max aggregate function. However, that might be a too simple solution for real data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pivoting-Apple-in-the-Testdata">Pivoting Apple in the Testdata<a class="anchor-link" href="#Pivoting-Apple-in-the-Testdata"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In a first step, we select only the BalanceSheet data of Apple in the testset and we expect to have 2 BalanceSheets in there (one for every quarter - since the testset contains two quarter of data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_df</span> <span class="o">=</span> <span class="n">df_tst</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;cik == 320193 and stmt = &#39;BS&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Check how many datarows there are for Apple in the two test quarters.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>134</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_vip_cols</span> <span class="o">=</span> <span class="n">apple_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;cik&#39;</span><span class="p">,</span><span class="s1">&#39;adsh&#39;</span><span class="p">,</span><span class="s1">&#39;period&#39;</span><span class="p">,</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;ddate&#39;</span><span class="p">,</span><span class="s1">&#39;uom&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;qtrs&#39;</span><span class="p">,</span><span class="s1">&#39;fp&#39;</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span><span class="s1">&#39;line&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_vip_cols</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+------+--------------------+----------+--------------------+------------+----------+---+----------+----+---+------+----+
|   cik|                adsh|    period|                 tag|     version|     ddate|uom|     value|qtrs| fp|report|line|
+------+--------------------+----------+--------------------+------------+----------+---+----------+----+---+------+----+
|320193|0000320193-19-000119|2019-09-30|  LiabilitiesCurrent|us-gaap/2019|2018-09-30|USD|1.15929E11|   0| FY|     4|  23|
|320193|0000320193-19-000119|2019-09-30|  LiabilitiesCurrent|us-gaap/2019|2019-09-30|USD|1.05718E11|   0| FY|     4|  23|
|320193|0000320193-19-000119|2019-09-30|ContractWithCusto...|us-gaap/2019|2018-09-30|USD|   5.966E9|   0| FY|     4|  20|
|320193|0000320193-19-000119|2019-09-30|ContractWithCusto...|us-gaap/2019|2019-09-30|USD|   5.522E9|   0| FY|     4|  20|
|320193|0000320193-19-000119|2019-09-30|              Assets|us-gaap/2019|2019-09-30|USD|3.38516E11|   0| FY|     4|  15|
|320193|0000320193-19-000119|2019-09-30|              Assets|us-gaap/2019|2018-09-30|USD|3.65725E11|   0| FY|     4|  15|
|320193|0000320193-19-000119|2019-09-30|CommonStocksInclu...|us-gaap/2019|2018-09-30|USD| 4.0201E10|   0| FY|     4|  31|
|320193|0000320193-19-000119|2019-09-30|CommonStocksInclu...|us-gaap/2019|2019-09-30|USD| 4.5174E10|   0| FY|     4|  31|
|320193|0000320193-19-000119|2019-09-30|OtherAssetsNoncur...|us-gaap/2019|2018-09-30|USD| 2.2283E10|   0| FY|     4|  13|
|320193|0000320193-19-000119|2019-09-30|OtherAssetsNoncur...|us-gaap/2019|2019-09-30|USD| 3.2978E10|   0| FY|     4|  13|
|320193|0000320193-19-000119|2019-09-30|     CommercialPaper|us-gaap/2019|2018-09-30|USD| 1.1964E10|   0| FY|     4|  21|
|320193|0000320193-19-000119|2019-09-30|     CommercialPaper|us-gaap/2019|2019-09-30|USD|    5.98E9|   0| FY|     4|  21|
|320193|0000320193-19-000119|2019-09-30|MarketableSecurit...|us-gaap/2019|2018-09-30|USD| 4.0388E10|   0| FY|     4|   4|
|320193|0000320193-19-000119|2019-09-30|MarketableSecurit...|us-gaap/2019|2019-09-30|USD| 5.1713E10|   0| FY|     4|   4|
|320193|0000320193-19-000119|2019-09-30|LongTermDebtNoncu...|us-gaap/2019|2018-09-30|USD| 9.3735E10|   0| FY|     4|  25|
|320193|0000320193-19-000119|2019-09-30|LongTermDebtNoncu...|us-gaap/2019|2019-09-30|USD| 9.1807E10|   0| FY|     4|  25|
|320193|0000320193-19-000119|2019-09-30|  StockholdersEquity|us-gaap/2019|2016-09-30|USD|1.28249E11|   0| FY|     4|  34|
|320193|0000320193-19-000119|2019-09-30|  StockholdersEquity|us-gaap/2019|2017-09-30|USD|1.34047E11|   0| FY|     4|  34|
|320193|0000320193-19-000119|2019-09-30|  StockholdersEquity|us-gaap/2019|2018-09-30|USD|1.07147E11|   0| FY|     4|  34|
|320193|0000320193-19-000119|2019-09-30|  StockholdersEquity|us-gaap/2019|2019-09-30|USD| 9.0488E10|   0| FY|     4|  34|
+------+--------------------+----------+--------------------+------------+----------+---+----------+----+---+------+----+
only showing top 20 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Checking the "ddate" column, we see entries that are in the past (compared to the "period" field  - which is the Balance Sheet Date, rounded to nearest month-end). This is normal, since the balancesheet also contains the data of the balance sheet from a year ago. However, in our case we are only interested in the data for the actual period. These are the entries where period and ddate have the same value.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_bs_per_period</span> <span class="o">=</span> <span class="n">apple_vip_cols</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;period == ddate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span><span class="s2">&quot;period&quot;</span><span class="p">,</span><span class="s2">&quot;report&quot;</span><span class="p">,</span><span class="s2">&quot;line&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_bs_per_period</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+------+--------------------+----------+--------------------+------------+----------+------+----------+----+---+------+----+
|   cik|                adsh|    period|                 tag|     version|     ddate|   uom|     value|qtrs| fp|report|line|
+------+--------------------+----------+--------------------+------------+----------+------+----------+----+---+------+----+
|320193|0000320193-19-000076|2019-06-30|CashAndCashEquiva...|us-gaap/2018|2019-06-30|   USD|  5.053E10|   0| Q3|     4|   3|
|320193|0000320193-19-000076|2019-06-30|MarketableSecurit...|us-gaap/2018|2019-06-30|   USD| 4.4084E10|   0| Q3|     4|   4|
|320193|0000320193-19-000076|2019-06-30|AccountsReceivabl...|us-gaap/2018|2019-06-30|   USD| 1.4148E10|   0| Q3|     4|   5|
|320193|0000320193-19-000076|2019-06-30|        InventoryNet|us-gaap/2018|2019-06-30|   USD|   3.355E9|   0| Q3|     4|   6|
|320193|0000320193-19-000076|2019-06-30|NontradeReceivabl...|us-gaap/2018|2019-06-30|   USD| 1.2326E10|   0| Q3|     4|   7|
|320193|0000320193-19-000076|2019-06-30|  OtherAssetsCurrent|us-gaap/2018|2019-06-30|   USD|  1.053E10|   0| Q3|     4|   8|
|320193|0000320193-19-000076|2019-06-30|       AssetsCurrent|us-gaap/2018|2019-06-30|   USD|1.34973E11|   0| Q3|     4|   9|
|320193|0000320193-19-000076|2019-06-30|MarketableSecurit...|us-gaap/2018|2019-06-30|   USD|1.15996E11|   0| Q3|     4|  11|
|320193|0000320193-19-000076|2019-06-30|PropertyPlantAndE...|us-gaap/2018|2019-06-30|   USD| 3.7636E10|   0| Q3|     4|  12|
|320193|0000320193-19-000076|2019-06-30|OtherAssetsNoncur...|us-gaap/2018|2019-06-30|   USD| 3.3634E10|   0| Q3|     4|  13|
|320193|0000320193-19-000076|2019-06-30|    AssetsNoncurrent|us-gaap/2018|2019-06-30|   USD|1.87266E11|   0| Q3|     4|  14|
|320193|0000320193-19-000076|2019-06-30|              Assets|us-gaap/2018|2019-06-30|   USD|3.22239E11|   0| Q3|     4|  15|
|320193|0000320193-19-000076|2019-06-30|AccountsPayableCu...|us-gaap/2018|2019-06-30|   USD| 2.9115E10|   0| Q3|     4|  18|
|320193|0000320193-19-000076|2019-06-30|OtherLiabilitiesC...|us-gaap/2018|2019-06-30|   USD| 3.1673E10|   0| Q3|     4|  19|
|320193|0000320193-19-000076|2019-06-30|ContractWithCusto...|us-gaap/2018|2019-06-30|   USD|   5.434E9|   0| Q3|     4|  20|
|320193|0000320193-19-000076|2019-06-30|     CommercialPaper|us-gaap/2018|2019-06-30|   USD|   9.953E9|   0| Q3|     4|  21|
|320193|0000320193-19-000076|2019-06-30| LongTermDebtCurrent|us-gaap/2018|2019-06-30|   USD| 1.3529E10|   0| Q3|     4|  22|
|320193|0000320193-19-000076|2019-06-30|  LiabilitiesCurrent|us-gaap/2018|2019-06-30|   USD| 8.9704E10|   0| Q3|     4|  23|
|320193|0000320193-19-000076|2019-06-30|LongTermDebtNoncu...|us-gaap/2018|2019-06-30|   USD| 8.4936E10|   0| Q3|     4|  25|
|320193|0000320193-19-000076|2019-06-30|OtherLiabilitiesN...|us-gaap/2018|2019-06-30|   USD| 5.1143E10|   0| Q3|     4|  26|
|320193|0000320193-19-000076|2019-06-30|LiabilitiesNoncur...|us-gaap/2018|2019-06-30|   USD|1.36079E11|   0| Q3|     4|  27|
|320193|0000320193-19-000076|2019-06-30|         Liabilities|us-gaap/2018|2019-06-30|   USD|2.25783E11|   0| Q3|     4|  28|
|320193|0000320193-19-000076|2019-06-30|CommitmentsAndCon...|us-gaap/2018|2019-06-30|   USD|      null|   0| Q3|     4|  29|
|320193|0000320193-19-000076|2019-06-30|CommonStocksInclu...|us-gaap/2018|2019-06-30|   USD| 4.3371E10|   0| Q3|     4|  31|
|320193|0000320193-19-000076|2019-06-30|RetainedEarningsA...|us-gaap/2018|2019-06-30|   USD| 5.3724E10|   0| Q3|     4|  32|
|320193|0000320193-19-000076|2019-06-30|AccumulatedOtherC...|us-gaap/2018|2019-06-30|   USD|   -6.39E8|   0| Q3|     4|  33|
|320193|0000320193-19-000076|2019-06-30|  StockholdersEquity|us-gaap/2018|2019-06-30|   USD| 9.6456E10|   0| Q3|     4|  34|
|320193|0000320193-19-000076|2019-06-30|LiabilitiesAndSto...|us-gaap/2018|2019-06-30|   USD|3.22239E11|   0| Q3|     4|  35|
|320193|0000320193-19-000076|2019-06-30|CommonStockParOrS...|us-gaap/2018|2019-06-30|   USD|       0.0|   0| Q3|     5|   1|
|320193|0000320193-19-000076|2019-06-30|CommonStockShares...|us-gaap/2018|2019-06-30|shares|   1.26E10|   0| Q3|     5|   2|
|320193|0000320193-19-000076|2019-06-30|CommonStockShares...|us-gaap/2018|2019-06-30|shares|4.531395E9|   0| Q3|     5|   3|
|320193|0000320193-19-000076|2019-06-30|CommonStockShares...|us-gaap/2018|2019-06-30|shares|4.531395E9|   0| Q3|     5|   4|
+------+--------------------+----------+--------------------+------------+----------+------+----------+----+---+------+----+
only showing top 32 rows

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Comparing the data above with the BalanceSheet in the appropriate report (<a href="https://www.sec.gov/ix?doc=/Archives/edgar/data/320193/000032019319000076/a10-qq320196292019.htm">https://www.sec.gov/ix?doc=/Archives/edgar/data/320193/000032019319000076/a10-qq320196292019.htm</a>) we see that the data and entries match.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we pivot the data and we expect two rows in the data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_pivoted_df</span> <span class="o">=</span> <span class="n">apple_bs_per_period</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span><span class="s2">&quot;period&quot;</span><span class="p">,</span><span class="s2">&quot;ddate&quot;</span><span class="p">,</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> \
                                      <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span><span class="s2">&quot;period&quot;</span><span class="p">,</span><span class="s2">&quot;ddate&quot;</span><span class="p">])</span> \
                                      <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,[</span><span class="s1">&#39;Assets&#39;</span><span class="p">,</span><span class="s1">&#39;AssetsCurrent&#39;</span><span class="p">,</span><span class="s1">&#39;OtherAssetsCurrent&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apple_pivoted_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span><span class="s2">&quot;period&quot;</span><span class="p">,</span><span class="s1">&#39;ddate&#39;</span><span class="p">,</span> <span class="s1">&#39;Assets&#39;</span><span class="p">,</span><span class="s1">&#39;AssetsCurrent&#39;</span><span class="p">,</span><span class="s1">&#39;OtherAssetsCurrent&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+------+--------------------+----------+----------+----------+-------------+------------------+
|   cik|                adsh|    period|     ddate|    Assets|AssetsCurrent|OtherAssetsCurrent|
+------+--------------------+----------+----------+----------+-------------+------------------+
|320193|0000320193-19-000119|2019-09-30|2019-09-30|3.38516E11|   1.62819E11|         1.2352E10|
|320193|0000320193-19-000076|2019-06-30|2019-06-30|3.22239E11|   1.34973E11|          1.053E10|
+------+--------------------+----------+----------+----------+-------------+------------------+

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The result looks promising.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Deciding-which-tags-to-pivot">Deciding which tags to pivot<a class="anchor-link" href="#Deciding-which-tags-to-pivot"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the analysis step we created a sorted list of the tags that are present in BalanceSheets. As was shown there, it doesn't make sense to pivot all 3400 tags. Instead, only a small subset appears often enough in reports to be useful. <br>
We stored the sorted list in the file "bs_tags.csv". No, we will load it and use the first 100 tags to define which values should be pivoted.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs_tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./bs_tags.csv&quot;</span><span class="p">)[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">relevant_tags</span> <span class="o">=</span> <span class="n">bs_tags</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pivoting">Pivoting<a class="anchor-link" href="#Pivoting"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pivot-the-testset">Pivot the testset<a class="anchor-link" href="#Pivot-the-testset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_bs_ready</span> <span class="o">=</span> <span class="n">df_tst</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;stmt = &#39;BS&#39; and period == ddate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;cik&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;adsh&#39;</span><span class="p">,</span><span class="s1">&#39;period&#39;</span><span class="p">,</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;ddate&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_bs_ready</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>208895</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_bs_ready</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1368</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_bs_pivot</span> <span class="o">=</span> <span class="n">df_test_bs_ready</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span><span class="s2">&quot;period&quot;</span><span class="p">,</span><span class="s2">&quot;ddate&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span><span class="n">relevant_tags</span><span class="p">)</span> \
                                   <span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_bs_pivot</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>5639</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_bs_pivot</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">tst_bs_folder</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pivot-the-whole-dataset">Pivot the whole dataset<a class="anchor-link" href="#Pivot-the-whole-dataset"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all_bs_ready</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;stmt = &#39;BS&#39; and period == ddate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;cik&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;adsh&#39;</span><span class="p">,</span><span class="s1">&#39;form&#39;</span><span class="p">,</span><span class="s1">&#39;period&#39;</span><span class="p">,</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all_bs_ready</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>4720704</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all_bs_ready</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2314</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all_bs_pivot</span> <span class="o">=</span> <span class="n">df_all_bs_ready</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;cik&quot;</span><span class="p">,</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span><span class="s2">&quot;form&quot;</span><span class="p">,</span><span class="s2">&quot;period&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span><span class="n">relevant_tags</span><span class="p">)</span> \
                                 <span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all_bs_pivot</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>131180</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to have an easy way to look at the data with a texteditor, we convert it to a pandas Dataframe and store it as CSV. The resulting file size is now 54 MB.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all_bs_pivot</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;bs_data.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>But for further processing, we also store it as parquet, since this will keep that datatype information of the columns.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">all_bs_folder</span><span class="p">,</span>  <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_all_bs_pivot</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cik&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">all_bs_folder</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Stop-the-SparkContext">Stop the SparkContext<a class="anchor-link" href="#Stop-the-SparkContext"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

