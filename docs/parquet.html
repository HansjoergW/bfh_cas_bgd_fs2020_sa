---

title: Parquet

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_parquet.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># common imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">bfh_cas_bgd_fs2020_sa.core</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Check the current working dir</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>C:\ieu\projects\bfh_cas_bgd_fs2020_sa
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Basic Definition</span>
<span class="n">data_folder</span> <span class="o">=</span> <span class="s2">&quot;./data/&quot;</span> <span class="c1"># folder with testdata</span>
<span class="n">temp_folder</span> <span class="o">=</span> <span class="s2">&quot;./tmp/&quot;</span>
<span class="n">parquet_folder</span> <span class="o">=</span> <span class="s2">&quot;./parquet/&quot;</span>
<span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2019q3.zip&#39;</span><span class="p">,</span><span class="s1">&#39;2019q4.zip&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Init-Spark">Init Spark<a class="anchor-link" href="#Init-Spark"> </a></h2><blockquote><p>This code initialises the SparkSession and therefore the SparkContext. Pressing the link "Spark UI" opens the Spark UI for this session.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># init Spark</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark_session</span><span class="p">()</span> <span class="c1"># Session anlegen</span>
<span class="n">spark</span> <span class="c1"># display the moste important information of the session</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

            <div>
                <p><b>SparkSession - in-memory</b></p>
                
        <div>
            <p><b>SparkContext</b></p>

            <p><a href="http://192.168.0.163:4040">Spark UI</a></p>

            <dl>
              <dt>Version</dt>
                <dd><code>v2.4.5</code></dd>
              <dt>Master</dt>
                <dd><code>local[*]</code></dd>
              <dt>AppName</dt>
                <dd><code>default</code></dd>
            </dl>
        </div>
        
            </div>
        
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Datafiles">Datafiles<a class="anchor-link" href="#Datafiles"> </a></h2><blockquote><p>The directory contains two zipfiles (2019q3.zip, 2019q4.zip). Each of them contains 4 csv files. The columns and the relation between these files are described in the readme.htm.
Each zip file contains all quarterly and yearly reports that were filled during the quarter denoted by the filename.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Unpacking">Unpacking<a class="anchor-link" href="#Unpacking"> </a></h3><blockquote><p>In a first step, the content of the files are unzipped and placed in separated folders</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
    <span class="n">path_to_zip_file</span> <span class="o">=</span> <span class="n">data_folder</span> <span class="o">+</span> <span class="n">data_file</span>
    <span class="n">directory_to_extract_to</span> <span class="o">=</span> <span class="n">temp_folder</span> <span class="o">+</span> <span class="n">data_file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">path_to_zip_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
        <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">directory_to_extract_to</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>the sizes of the directories</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data folder: &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">get_directory_size</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Temp folder: &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">get_directory_size</span><span class="p">(</span><span class="n">temp_folder</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Data folder:  76.58MB
Temp folder:  748.04MB
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-Parquet">Using Parquet<a class="anchor-link" href="#Using-Parquet"> </a></h2><blockquote><p>let us read a csv file and store it as a parquet file</p>
<ul>
<li>API doc of the csv reader:<a href="https://spark.apache.org/docs/2.4.5/api/python/pyspark.sql.html?highlight=parquet#pyspark.sql.DataFrameReader.csv&gt;">https://spark.apache.org/docs/2.4.5/api/python/pyspark.sql.html?highlight=parquet#pyspark.sql.DataFrameReader.csv&gt;</a> * API doc of the parquet writer:<a href="https://spark.apache.org/docs/2.4.5/api/python/pyspark.sql.html?highlight=parquet#pyspark.sql.DataFrameWriter.parquet">https://spark.apache.org/docs/2.4.5/api/python/pyspark.sql.html?highlight=parquet#pyspark.sql.DataFrameWriter.parquet</a></li>
</ul>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># imports that are used in this section</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">DateType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">IntegerType</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">countDistinct</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># as a test csv file, &quot;num.txt&quot; from the folder 2019q3 is used</span>
<span class="n">test_file</span> <span class="o">=</span> <span class="n">temp_folder</span> <span class="o">+</span> <span class="s1">&#39;2019q3/num.txt&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;size of test file: &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">test_file</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>size of test file:  236.70MB
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Reading-a-CSV-file">Reading a CSV file<a class="anchor-link" href="#Reading-a-CSV-file"> </a></h3><blockquote><p>As a first step, the csv file has to be loaded into a spark df. 
The file has a header row and the columns are separated by a TAB (\t).</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_num</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>When checking the format in the next cell, we see that all columns were read as a string. That is ok for most of the columns but when checking the definitions for the num.txt file in the readme.htm we see, that ddate is a date in the format 'yyyymmdd', qtrs and coreg are 'int' and value is a float.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;first row:      &#39;</span><span class="p">,</span> <span class="n">df_test_num</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of rows :&#39;</span><span class="p">,</span> <span class="n">df_test_num</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">df_test_num</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>first row:       [Row(adsh=&#39;0001625376-19-000017&#39;, tag=&#39;EntityPublicFloat&#39;, version=&#39;dei/2014&#39;, coreg=None, ddate=&#39;20180430&#39;, qtrs=&#39;0&#39;, uom=&#39;USD&#39;, value=&#39;0.0000&#39;, footnote=None)]
number of rows : 2325267
root
 |-- adsh: string (nullable = true)
 |-- tag: string (nullable = true)
 |-- version: string (nullable = true)
 |-- coreg: string (nullable = true)
 |-- ddate: string (nullable = true)
 |-- qtrs: string (nullable = true)
 |-- uom: string (nullable = true)
 |-- value: string (nullable = true)
 |-- footnote: string (nullable = true)

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># show how many different reports are available in this quarter</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">df_test_num</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">countDistinct</span><span class="p">(</span><span class="s2">&quot;adsh&quot;</span><span class="p">))</span>
<span class="n">df2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>+--------------------+
|count(DISTINCT adsh)|
+--------------------+
|                6283|
+--------------------+

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Acutally, spark can try to infer the types of the columns from the data itself, so lets try that by using the "inferSchema" option</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_num</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>As we can see in the next cell, we were only partially sucessfull. The reader was able to detect that qtrs is an integer and that value is a double. But it failed to recognize that ddate is actually a date and that coreg should be an int. That was to be expected:ddate looks like an int and the coreg field is only used in special situations, so there is a good change that its content is None for all entries in the file. 
It looks as if we have to define the schema by hand</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_test_num</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">df_test_num</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[Row(adsh=&#39;0001625376-19-000017&#39;, tag=&#39;EntityPublicFloat&#39;, version=&#39;dei/2014&#39;, coreg=None, ddate=20180430, qtrs=0, uom=&#39;USD&#39;, value=0.0, footnote=None)]
root
 |-- adsh: string (nullable = true)
 |-- tag: string (nullable = true)
 |-- version: string (nullable = true)
 |-- coreg: string (nullable = true)
 |-- ddate: integer (nullable = true)
 |-- qtrs: integer (nullable = true)
 |-- uom: string (nullable = true)
 |-- value: double (nullable = true)
 |-- footnote: string (nullable = true)

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>All necessary classes to define a schema are located inside the package pyspark.sql.types and for our example we need the following import
from pyspark.sql.types import StructType, StructField, StringType, DateType, DoubleType, IntegerType</p>
<p>An important point is that the dateFormat has to be defined as parameter when calling spark.read.csv()</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;adsh&quot;</span><span class="p">,</span>    <span class="n">StringType</span><span class="p">(),</span>  <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span>     <span class="n">StringType</span><span class="p">(),</span>  <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span>  <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;coreg&quot;</span><span class="p">,</span>   <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ddate&quot;</span><span class="p">,</span>   <span class="n">DateType</span><span class="p">(),</span>    <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;qtrs&quot;</span><span class="p">,</span>    <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;uom&quot;</span><span class="p">,</span>     <span class="n">StringType</span><span class="p">(),</span>  <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>   <span class="n">DoubleType</span><span class="p">(),</span>  <span class="kc">True</span><span class="p">),</span>\
                     <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;footnote&quot;</span><span class="p">,</span><span class="n">StringType</span><span class="p">(),</span>  <span class="kc">True</span><span class="p">)</span>\
                    <span class="p">])</span>
<span class="n">df_test_num</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dateFormat</span><span class="o">=</span><span class="s2">&quot;yyyyMMdd&quot;</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_test_num</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">df_test_num</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[Row(adsh=&#39;0001625376-19-000017&#39;, tag=&#39;EntityPublicFloat&#39;, version=&#39;dei/2014&#39;, coreg=None, ddate=datetime.date(2018, 4, 30), qtrs=0, uom=&#39;USD&#39;, value=0.0, footnote=None)]
root
 |-- adsh: string (nullable = true)
 |-- tag: string (nullable = true)
 |-- version: string (nullable = true)
 |-- coreg: integer (nullable = true)
 |-- ddate: date (nullable = true)
 |-- qtrs: integer (nullable = true)
 |-- uom: string (nullable = true)
 |-- value: double (nullable = true)
 |-- footnote: string (nullable = true)

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="simple-write-as-Parquet">simple write as Parquet<a class="anchor-link" href="#simple-write-as-Parquet"> </a></h3><blockquote><p>As first version the dataframe is stored directly in parquet format without additional options</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parquet_folder_pure</span> <span class="o">=</span> <span class="n">parquet_folder</span><span class="o">+</span><span class="s2">&quot;pure/&quot;</span>
<span class="n">df_test_num</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">parquet_folder_pure</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span> <span class="c1"># mode &#39;overwrite&#39; overwrites the data, if they are already present</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;size of parquet_folder_pure: &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">get_directory_size</span><span class="p">(</span><span class="n">parquet_folder_pure</span><span class="p">)))</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parquet_folder_pure</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>size of parquet_folder_pure:  19.11MB
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;.part-00000-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00001-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00002-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00003-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00004-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00005-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00006-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;.part-00007-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet.crc&#39;,
 &#39;._SUCCESS.crc&#39;,
 &#39;part-00000-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00001-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00002-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00003-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00004-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00005-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00006-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;part-00007-3a794cdc-cafe-4f3c-b453-eae790147e01-c000.snappy.parquet&#39;,
 &#39;_SUCCESS&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Parquet was able to compress the data down to about 10% of the orginal size. It splitted the data up in 8 different data files. So every file is containing approximatly 300'000 data rows and has a size of about 3MB</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="writing-using-partitions">writing using partitions<a class="anchor-link" href="#writing-using-partitions"> </a></h3><blockquote><p>Parquet can also store the data in different partitions wich will create a new directory for every partition.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>As a first approach, we could try to create a partition for every report that means for every distinct "adsh" value. However, since we have about 6300 different reports in the used csv file that would result in data files less than 5kb each. Such small files are very inefficient for parquet, so we do soemthing else.</p>
<p>Since we read the "ddate" column as a proper date-format we can create partitions based on the year and month. In order to do that we need to add two columns for year and month to the dataframe.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_num</span> <span class="o">=</span> <span class="n">df_test_num</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">(</span><span class="s2">&quot;ddate&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">month</span><span class="p">(</span><span class="s2">&quot;ddate&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parquet_folder_by_month</span> <span class="o">=</span> <span class="n">parquet_folder</span><span class="o">+</span><span class="s2">&quot;month&quot;</span>
<span class="n">df_test_num</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">parquet_folder_by_month</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Looking at the result may be a little surprising. There are folders for years starting 1978 up to 2028. The 'ddate' column is defined as "The end date for the data value, rounded to the nearest month end". A lot of values that appear in a report may not be from reported period. For instance, often results from the last couple of years are also included in a yearly report. Or expected returns for the following couple of years appear in the report.</p>
<p>The total size of on disk has also increased significantly. It is still small compared to the originial CSV file, but around 25% to 30% bigger compared to the size that was needed when the data were stored without defining partitions.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;size of parquet_folder_month: &#39;</span><span class="p">,</span> <span class="n">get_size_format</span><span class="p">(</span><span class="n">get_directory_size</span><span class="p">(</span><span class="n">parquet_folder_by_month</span><span class="p">)))</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parquet_folder_by_month</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>size of parquet_folder_month:  26.72MB
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;._SUCCESS.crc&#39;,
 &#39;year=1978&#39;,
 &#39;year=1982&#39;,
 &#39;year=1987&#39;,
 &#39;year=1989&#39;,
 &#39;year=1990&#39;,
 &#39;year=1993&#39;,
 &#39;year=1994&#39;,
 &#39;year=1995&#39;,
 &#39;year=1996&#39;,
 &#39;year=1997&#39;,
 &#39;year=1998&#39;,
 &#39;year=1999&#39;,
 &#39;year=2000&#39;,
 &#39;year=2001&#39;,
 &#39;year=2002&#39;,
 &#39;year=2003&#39;,
 &#39;year=2004&#39;,
 &#39;year=2005&#39;,
 &#39;year=2006&#39;,
 &#39;year=2007&#39;,
 &#39;year=2008&#39;,
 &#39;year=2009&#39;,
 &#39;year=2010&#39;,
 &#39;year=2011&#39;,
 &#39;year=2012&#39;,
 &#39;year=2013&#39;,
 &#39;year=2014&#39;,
 &#39;year=2015&#39;,
 &#39;year=2016&#39;,
 &#39;year=2017&#39;,
 &#39;year=2018&#39;,
 &#39;year=2019&#39;,
 &#39;year=2020&#39;,
 &#39;year=2021&#39;,
 &#39;year=2022&#39;,
 &#39;year=2023&#39;,
 &#39;year=2025&#39;,
 &#39;year=2027&#39;,
 &#39;year=2028&#39;,
 &#39;year=__HIVE_DEFAULT_PARTITION__&#39;,
 &#39;_SUCCESS&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="reading-parquet">reading parquet<a class="anchor-link" href="#reading-parquet"> </a></h3><blockquote><p>reading parquet is even simpler as reading a cvs since parquet contains metainformation about the file structure</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_test_num</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">parquet_folder_pure</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of rows :&#39;</span><span class="p">,</span> <span class="n">df_test_num</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">df_test_num</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>number of rows : 2325267
root
 |-- adsh: string (nullable = true)
 |-- tag: string (nullable = true)
 |-- version: string (nullable = true)
 |-- coreg: integer (nullable = true)
 |-- ddate: date (nullable = true)
 |-- qtrs: integer (nullable = true)
 |-- uom: string (nullable = true)
 |-- value: double (nullable = true)
 |-- footnote: string (nullable = true)

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

